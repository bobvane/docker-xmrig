name: Check XMRig Release and Trigger Build

on:
  schedule:
    - cron: '0 0 1 * *'  # æ¯æœˆ 1 æ—¥å‡Œæ™¨ 00:00 UTC
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check-xmrig-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æ¨é€ Dockerfile æ›´æ”¹
      actions: write   # è§¦å‘å…¶ä»–å·¥ä½œæµ
    outputs:
      version: ${{ steps.check-release.outputs.version }}
      should_build: ${{ steps.check-release.outputs.should_build }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # ç¡®ä¿ä½¿ç”¨ GITHUB_TOKEN

      - name: Check latest XMRig release
        id: check-release
        run: |
          # ä½¿ç”¨ GitHub API è·å– xmrig/xmrig æœ€æ–° Release
          RELEASE_INFO=$(curl -s https://api.github.com/repos/xmrig/xmrig/releases/latest)
          
          # æå–ç‰ˆæœ¬å·å’Œé¢„å‘å¸ƒçŠ¶æ€
          VERSION=$(echo "$RELEASE_INFO" | jq -r '.tag_name')
          PRERELEASE=$(echo "$RELEASE_INFO" | jq -r '.prerelease')
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºæ­£å¼ç‰ˆæœ¬
          if [ "$PRERELEASE" = "false" ]; then
            echo "Found new non-prerelease version: $VERSION"
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "Latest release ($VERSION) is a prerelease, skipping build"
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi
          
          # ä¿å­˜ç‰ˆæœ¬å·åˆ°è¾“å‡º
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Debug Dockerfile before update
        if: steps.check-release.outputs.should_build == 'true'
        run: |
          echo "Current Dockerfile content:"
          cat Dockerfile

      - name: Update Dockerfile with new XMRig version
        if: steps.check-release.outputs.should_build == 'true'
        run: |
          VERSION=${{ steps.check-release.outputs.version }}
          # æ›¿æ¢ XMRIG_VERSION
          if grep -q "ARG XMRIG_VERSION=" Dockerfile; then
            sed -i "s|ARG XMRIG_VERSION=.*|ARG XMRIG_VERSION=$VERSION|" Dockerfile
            echo "Updated XMRIG_VERSION to $VERSION"
          else
            echo "Error: ARG XMRIG_VERSION not found in Dockerfile"
            exit 1
          fi

          # æ£€æŸ¥ä¿®æ”¹ç»“æœ
          echo "Changes in Dockerfile:"
          git diff || true

      - name: Commit and push Dockerfile changes
        if: steps.check-release.outputs.should_build == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Dockerfile
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "No changes in Dockerfile, skipping commit"
          else
            git commit -m "Update XMRig and CUDA plugin to ${{ steps.check-release.outputs.version }}"
            git push
          fi

      - name: Trigger Docker build workflow
        if: steps.check-release.outputs.should_build == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            # æŠŠæ­¥éª¤è¾“å‡ºå…ˆæ”¾åˆ°ä¸€ä¸ª JS å­—ç¬¦ä¸²å˜é‡é‡Œï¼ˆå¿…é¡»ç”¨å¼•å·ï¼‰           # ğŸ”´
            const version = "${{ steps.check-release.outputs.version }}";  # ğŸ”´
            console.log(`Triggering docker-build.yaml with xmrig_version=${version}`);  # ğŸ”´

            await github.rest.actions.createWorkflowDispatch({              # ğŸ”´
              owner: context.repo.owner,                                   # ğŸ”´
              repo: context.repo.repo,                                     # ğŸ”´
              workflow_id: "docker-build.yaml",                            # ğŸ”´
              ref: "master",                                               # ğŸ”´
              inputs: { xmrig_version: version }                           # ğŸ”´
            });                                                            # ğŸ”´

